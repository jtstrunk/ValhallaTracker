<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/addGame.css') }}">
    <title>Add Game Record</title>
</head>
<body>
    {% extends "base.html" %}
    {% import "bootstrap/wtf.html" as wtf %}
    {% block content %}

    <div id="content">
        <div class="card" onclick="createPopup('Dominion', 4)">
            <div class="img">
                <img src="/static/images/addgame/dominion.png">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Dominion</p>
                <p style="font-size: large;">2 - 4 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="createPopup('Catan', 4)">
            <div class="img">
                <img src="/static/images/addgame/catan.png">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Catan</p>
                <p style="font-size: large;">2 - 4 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="createPopup('Clank!', 4)">
            <div class="img">
                <img src="/static/images/addgame/clank.png">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Clank!</p>
                <p style="font-size: large;">2 - 4 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="createPopup('Moonrakers', 5)">
            <div class="img">
                <img src="/static/images/addgame/moonrakers.png">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Moonrakers</p>
                <p style="font-size: large;">1 - 5 Players</p>
                <div style="margin-top: 7px;">
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="createPopup('Lords of Waterdeep', 5)">
            <div class="img">
                <img src="/static/images/addgame/lordsofwaterdeep.png">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Lords of Waterdeep</p>
                <p style="font-size: large;">3 - 5 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="createPopup('Cosmic Encounter', 5)">
            <div class="img">
                <img src="/static/images/addgame/CosmicEncounter.png">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Cosmic Encounter</p>
                <p style="font-size: large;">3 - 5 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="createPopupParty('Exploding Kittens', 10)">
            <div class="img">
                <img src="/static/images/addgame/ExplodingKittens.png">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Exploding Kittens</p>
                <p style="font-size: large;">2 - 10 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="createPopup('Sushi Go Party', 8)">
            <div class="img">
                <img src="/static/images/addgame/SushiGoParty.png">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Sushi Go Party</p>
                <p style="font-size: large;">2 - 8 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="img">
                <img src="/static/images/addgame/loveletter.jpg">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Love Letter</p>
                <p style="font-size: large;">3 - 5 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="img">
                <img src="/static/images/addgame/themind.png">
            </div>
            <div class="text">
                <p style="font-size: 24px;">The Mind</p>
                <p style="font-size: large;">2 - 4 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="img">
                <img src="/static/images/addgame/pandemic.jpg">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Pandemic</p>
                <p style="font-size: large;">2 - 4 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="img">
                <img src="/static/images/addgame/coup.jpg">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Coup</p>
                <p style="font-size: large;">4 - 8 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="img">
                <img src="/static/images/addgame/codenames.jpg">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Codenames</p>
                <p style="font-size: large;">4 - 10 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="createPopup('Here to Slay', 6)">
            <div class="img">
                <img src="/static/images/addgame/heretoslay.jpg">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Here to Slay</p>
                <p style="font-size: large;">2 - 6 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

        <div class="card" onclick="createPopup('Munchkin', 6)">
            <div class="img">
                <img src="/static/images/addgame/munchkin.jpg">
            </div>
            <div class="text">
                <p style="font-size: 24px;">Munchkin</p>
                <p style="font-size: large;">3 - 6 Players</p>
                <div>
                    <span class="bottom">Add a</span>&nbsp;<span class="bottom" style="text-decoration: underline;">game</span>
                </div>
            </div>
        </div>

    </div>
    <div id="overlay" class="Hide"> </div>
    <div id="popups"> </div>

    <script>
        function createPopup(game, maxLength){
            overlay.classList.remove("Hide");
            // Create the main div
            const Popup = document.createElement('div');
            Popup.id = 'Popup';
            Popup.classList.add('gamepopup');

            if(maxLength == 4){
                Popup.style.height = '415px';
            } else if (maxLength == 5) {
                Popup.style.height = '490px';
            } else if (maxLength == 6) {
                Popup.style.height = '565px';
            } else if (maxLength == 8) {
                Popup.style.height = '700px';
            }

            // Create the close button
            const closeButton = document.createElement('p');
            closeButton.classList.add('close-button');
            closeButton.textContent = 'x';
            closeButton.addEventListener('click', () => {
              overlay.classList.add("Hide");
              popup = document.querySelector("#Popup");
              popup.remove()
            })
            Popup.appendChild(closeButton);

            // Create the heading
            const heading = document.createElement('h2');
            heading.style.color = 'white';
            heading.textContent = `Add ${game} Record`;
            Popup.appendChild(heading);

            // Create the form
            const form = document.createElement('form');
            if (game == 'Dominion') {
                form.action = `{{ url_for('addDominion') }}`;
            } else if (game == 'Catan') {
                form.action = `{{ url_for('addCatan') }}`;
            } else if (game == 'Lords of Waterdeep') {
                form.action = `{{ url_for('addLordsofWaterdeep') }}`;
            } else if (game == 'Moonrakers') {
                form.action = `{{ url_for('addMoonrakers') }}`;
            } else if (game == 'Cosmic Encounter') {
                form.action = `{{ url_for('addCosmicEncounter') }}`;
            } else if (game == 'Clank!') {
                form.action = `{{ url_for('addClank') }}`;
            } else if (game == 'Sushi Go Party') {
                form.action = `{{ url_for('addSushiGoParty') }}`;
            }

            form.method = "POST";
            form.autocomplete = "off";
            form.style = "margin-top: 10px !important;"

            const labels = ["Winner", "Runner Up", "Third Place", "Fourth Place", "Fifth Place", "Sixth Place", "Seventh Place", "Eighth Place", "Ninth Place", "Tenth Place"];
            const games = ["dominion" , "catan", "moonrakers", "lordsofwaterdeep", "cosmicencounter", "explodingkittens", "sushigoparty"];
            // ... (Create and append other elements)
            for(let i = 1; i < maxLength + 1; i++) {
                //creating players div to organize the inputs
                let div = document.createElement('div');
                div.classList.add('players');
                //creating the first label and name input
                let playersecion = document.createElement('div');
                playersecion.classList.add('playerSection');
                const label = document.createElement('label');
                label.htmlFor = `Player${i}`;
                label.textContent = labels[i - 1];
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `Player${i}`;
                input.name = `Player${i}`;
                input.placeholder = 'Name';
                input.addEventListener('keyup', function() {
                    showResults(this.value, this.id);
                });
                playersecion.appendChild(label);
                playersecion.appendChild(input);   
                //creating the second label and score input
                let playersecion2 = document.createElement('div');
                playersecion2.classList.add('playerSection');
                const label2 = document.createElement('label');
                label2.htmlFor = `Score${i}`;
                label2.textContent = 'Score';
                const input2 = document.createElement('input');
                input2.type = 'text';
                input2.id = `Score${i}`;
                input2.name = `Score${i}`;
                input2.placeholder = 'Score';
                playersecion2.appendChild(label2);
                playersecion2.appendChild(input2);
                //adding them all
                div.appendChild(playersecion);
                div.appendChild(playersecion2);
                form.appendChild(div);
            }

            let gamesWithExpansions = ['Dominion', 'Lords of Waterdeep', 'Moonrakers', 'Catan'];

            let outerExpansions = document.createElement('div');
            outerExpansions.style = 'display: flex; flex-direction: column; border-radius: 5px; !important';
            let expansionLabel = document.createElement('label');
            expansionLabel.textContent = 'Expansions';
            expansionLabel.htmlFor = 'expansions';

            let tagsContainer = document.createElement('div');
            tagsContainer.id = 'tagsContainer';

            //tagsContainer
            outerExpansions.appendChild(expansionLabel);
            //outerExpansions.appendChild(tagsContainer);

            let taggedExpansions = document.createElement('div');
            taggedExpansions.id = 'taggedExpansions';


            let expansions = document.createElement('input');
            expansions.id = 'expansions';
            expansions.placeholder = 'Expansion Name';

            outerExpansions.appendChild(expansions);
            outerExpansions.appendChild(taggedExpansions);

            let foundExpansions = document.createElement('div');
            foundExpansions.id = 'foundExpansions';
            foundExpansions.classList.add('expansionResults');
            foundExpansions.classList.add('Hide');

            //expansions.addEventListener("beforeinput", handleKeyDown);
            

            expansions.addEventListener('keyup', function() {
                showExpansions(this.value, game);
            });

            outerExpansions.appendChild(foundExpansions);
            form.appendChild(outerExpansions);

            let expansionInput = document.createElement('input');
            expansionInput.id = 'expansionnames';
            expansionInput.name = 'expansionnames';
            expansionInput.classList.add('Hide');
            form.appendChild(expansionInput);

            if (!gamesWithExpansions.includes(game)) {
                outerExpansions.classList.add('Hide');
            } else {
                let currentHeight = parseInt(Popup.style.height) || Popup.offsetHeight;
                console.log("Current height:", currentHeight);
                let newHeight = currentHeight + 75;
                Popup.style.height = newHeight + 'px';
                console.log("New height:", Popup.style.height);
            }

            let button = document.createElement('button');
            button.style = "margin-top: 10px";
            button.classList.add('btn');
            button.classList.add('btn-primary');
            button.innerText = 'Submit Record';

            form.appendChild(button);
            Popup.appendChild(form);

            document.body.appendChild(Popup);
        }
        
        let cards = document.querySelectorAll(".card");
        let gamepopups = document.querySelectorAll(".gamepopup");
        let closebuttons = document.querySelectorAll(".close-button");
        let overlay = document.querySelector("#overlay");

        overlay.addEventListener('click', () => {
            overlay.classList.add("Hide");
            Popup = document.querySelector("#Popup");
            Popup.remove();
        })

        fetch('/returnFriends')
        .then(response => response.json())
        .then(data => {
            search_terms = data;
            console.log(search_terms);
        })
        .catch(error => console.error(error));

        function findExpansions(game, input) {
            const expansions = {
                'Dominion': ['Dominion', 'Seaside', 'Intrigue', 'Prosperity', 'Hinterlands', 'Dark Ages', 'Adventures'],
                'Moonrakers': ['Binding Ties', 'Nomad', 'Overload', 'The Shard', 'The Endless', 'Dark Matter', 'Starfall'],
                'Lords of Waterdeep': ['Scoundrels of Skullport'],
                'Clank!': ['Sunken Treasure', "The Mummy's Curse", 'Adventuring Party', 'Expeditions: Gold and Silk', 'Expeditions: Temple of the Ape Lords'],
                'Catan': ['Cities & Knights', 'Seafarers']
            };
            let gameExpansions = expansions[game];
            if (input == '') {
                return [];
            }
            var reg = new RegExp(input,'i')
            return gameExpansions.filter(function(term) {
                if (term.match(reg)) {
                return term;
                }
            });
        }

        function showExpansions(val, game) {
            let res = document.querySelector('.expansionResults');
            console.log(res)
            res.innerHTML = '';
            let list = '';
            if (val === '') {
                res.classList.add("Hide");
                return;
            } else {
                if(res.classList.contains('Hide')){
                    res.classList.remove("Hide");
                }
            }
            let terms = findExpansions(game, val);
            let selectedExpansions = document.querySelectorAll('.selectedExpansion');

            let selectedExpansionsArray = Array.from(selectedExpansions).map(el => el.textContent.trim());
            console.log(terms);
            let filteredTerms = terms.filter(term => !selectedExpansionsArray.includes(term));
            console.log(filteredTerms);
            for (i = 0; i < filteredTerms.length; i++) {
                let resultItem = document.createElement('div');
                resultItem.textContent = filteredTerms[i];
                resultItem.classList.add('result-item')
                //list += '<li>' + terms[i] + '</li>';
                res.appendChild(resultItem);
            }

            // Add event listener to each li element
            let liElements = document.querySelectorAll(`.result-item`);
            liElements.forEach(function(li) {
                li.addEventListener('click', function() {
                    createExpansion(li);
                    res.innerHTML = '';
                    res.classList.add("Hide");
                    let expansions = document.querySelector('#expansions');
                    expansions.value = '';
                    
                    let expansionnames = document.querySelector("#expansionnames");
                    expansionnames.value = '';
                    let usedExpansions = document.querySelectorAll('.selectedExpansion')
                    for (let i = 0; i < usedExpansions.length; i++) {
                        console.log(usedExpansions[i].innerHTML)
                        expansionnames.value += `${usedExpansions[i].innerHTML}`;
                        if (i < usedExpansions.length - 1) {
                            expansionnames.value += ', ';
                        }
                    }
                    console.log('expansionnames.innerHTML');
                    console.log(expansionnames.value);
                });
            });

            document.addEventListener('click', function(event) {
                if (!event.target.closest('#expansions') && !event.target.closest('.expansionResults')) {
                    res.classList.add("Hide");
                }
            });
        }

        function createExpansion(expansionName){
            console.log(expansionName.innerText, "Clicked!");
            let taggedExpansions = document.querySelector("#taggedExpansions");
            let tagContainer = document.createElement('div');
            let name = document.createElement('Span');
            let close = document.createElement('Span');
            name.innerHTML = `${expansionName.innerText}`;
            name.classList.add("selectedExpansion");
            close.innerHTML = ' X';
            close.classList.add('removeExpansion');

            close.addEventListener('click', () => {
                console.log('clicked on remove');
                close.parentNode.remove();
            })

            tagContainer.appendChild(name);
            tagContainer.appendChild(close);
            taggedExpansions.appendChild(tagContainer);
        }

        function autocompleteMatch(input) {
            if (input == '') {
                return [];
            }
            var reg = new RegExp(input,'i')
            return search_terms.filter(function(term) {
                if (term.match(reg)) {
                return term;
                }
            });
        }

        function showResults(val, id) {
            console.log(val);
            console.log(id);
            // let parts = id.split(/(\d+)/);
            // let part = parts[0];
            // let gameName = part.slice(0, -6);
            // console.log("GAME");
            // console.log(gameName);
            // let index = id.search(/\d/);
            // let num = id.substring(index);
            // console.log(num);
            // results = document.querySelectorAll(`.${gameName}results`);
            // results[num - 1].classList.remove("Hide");
            // let res = results[num - 1]
            // res.innerHTML = '';
            // let list = '';
            // if (val === '') {
            //     res.classList.add("Hide");
            //     return;
            // }
            // let terms = autocompleteMatch(val);
            // for (i=0; i<terms.length; i++) {
            //     list += '<li>' + terms[i] + '</li>';
            // }
            // res.innerHTML = '<ul>' + list + '</ul>';

            // // Add event listener to each li element
            // let liElements = document.querySelectorAll(`.${gameName}results li`);
            // liElements.forEach(function(li) {
            //     li.addEventListener('click', function() {
            //         document.querySelector(`#${gameName}Player${num}`).value = li.innerText;
            //         res.innerHTML = '';
            //         res.classList.add("Hide");
            //     });
            // });

            // document.addEventListener('click', function(event) {
            //     if (!event.target.closest(`#${gameName}Player${num}`) && !event.target.closest(`.${gameName}results`)) {
            //         res.classList.add("Hide");
            //     }
            // });

        }

        function createPopupParty(game, maxLength){
            overlay.classList.remove("Hide");
            // Create the main div
            const Popup = document.createElement('div');
            Popup.id = 'Popup';
            Popup.classList.add('gamepopup');

            Popup.style.height = '490px';

            // Create the close button
            const closeButton = document.createElement('p');
            closeButton.classList.add('close-button');
            closeButton.textContent = 'x';
            closeButton.addEventListener('click', () => {
              overlay.classList.add("Hide");
              popup = document.querySelector("#Popup");
              popup.remove()
            })
            Popup.appendChild(closeButton);

            // Create the heading
            const heading = document.createElement('h2');
            heading.style.color = 'white';
            heading.textContent = `Add ${game} Record`;
            Popup.appendChild(heading);

            // Create the form
            const form = document.createElement('form');

            if (game == 'Exploding Kittens') {
                form.action = `{{ url_for('addExplodingKittens') }}`;
            }
            form.method = "POST";
            form.autocomplete = "off";
            form.style = "margin-top: 10px !important;"

            const labels = ["Winner", "Runner Up", "Third Place", "Fourth Place", "Fifth Place", "Sixth Place", "Seventh Place", "Eighth Place", "Ninth Place", "Tenth Place"];
            // ... (Create and append other elements)
            for(let i = 1; i < maxLength + 1; i += 2) {
                //creating players div to organize the inputs
                let div = document.createElement('div');
                div.classList.add('players');
                //creating the first label and name input
                let playersecion = document.createElement('div');
                playersecion.classList.add('playerSection');
                let label = document.createElement('label');
                label.htmlFor = `Player${i}`;
                label.textContent = labels[i - 1];
                let input = document.createElement('input');
                input.type = 'text';
                input.id = `Player${i}`;
                input.name = `Player${i}`;
                input.placeholder = 'Name';
                input.addEventListener('keyup', function() {
                    showResults(this.value, this.id);
                });
                playersecion.appendChild(label);
                playersecion.appendChild(input);   

                //creating the second label and name input
                let playersecion2 = document.createElement('div');
                playersecion2.classList.add('playerSection');
                let label2 = document.createElement('label');
                label2.htmlFor = `Player${i + 1}`;
                label2.textContent = labels[i];
                let input2 = document.createElement('input');
                input2.type = 'text';
                input2.id = `Player${i + 1}`;
                input2.name = `Player${i + 1}`;
                input2.placeholder = 'Name';
                input2.addEventListener('keyup', function() {
                    showResults(this.value, this.id);
                });
                playersecion2.appendChild(label2);
                playersecion2.appendChild(input2);   
                
                //adding them all
                div.appendChild(playersecion);
                div.appendChild(playersecion2);
                form.appendChild(div);
            }

            console.log("what is");

            let button = document.createElement('button');
            button.style = "margin-top: 10px";
            button.classList.add('btn');
            button.classList.add('btn-primary');
            button.innerText = 'Submit Record';

            form.appendChild(button);
            Popup.appendChild(form);

            document.body.appendChild(Popup);
        }

        function addExpansion(){
            console.log("adding expansion")
            let gameid = 59;
            let strings = 'Seaside, Intrigue';
            fetch(`/addExpansion?gameid=${gameid}&expansionsString=${strings}`)
            .then(response => response.json())
            .then(data => {
                search_terms = data;
                console.log(search_terms);
            })
            .catch(error => console.error(error));

        }

        function showExpansion(){
            console.log("adding expansion")
            let gameid = 59;
            fetch(`/retrieveExpansion?gameid=${gameid}`)
            .then(response => response.json())
            .then(data => {
                if (data.expansions) {
                    console.log("Expansions:", data.expansions);
                    // Handle the expansions data here
                } else {
                    console.log("No expansions found for this game");
                }
            })
            .catch(error => console.error(error));

        }

    </script>
    {% endblock %}
</body>
</html>